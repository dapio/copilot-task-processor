/**
 * Microsoft Reviewer Agent
 * Specialized agent for Microsoft code review and analysis
 */

// Agent interface implementation
import { MicrosoftReviewerLogic } from './services/microsoft-reviewer.logic';
import { IMLProvider } from '../providers/ml-provider.interface';
import {
  CodeReviewResult,
  SecurityAnalysis,
  PerformanceAnalysis,
  MicrosoftAssessment,
  CodeChange,
} from './types/microsoft-reviewer.types';

export class MicrosoftReviewerAgent {
  public readonly name = 'Microsoft Reviewer Agent';
  public readonly description =
    'Ekspert przeglƒÖdu kodu Microsoft - Azure, .NET, bezpiecze≈Ñstwo i wydajno≈õƒá';
  public readonly version = '1.0.0';
  public readonly category = 'code-review';
  public readonly tags = [
    'microsoft',
    'azure',
    'dotnet',
    'security',
    'performance',
    'code-review',
  ];

  private logic: MicrosoftReviewerLogic;

  constructor(private mlProvider: IMLProvider) {
    this.logic = new MicrosoftReviewerLogic(mlProvider);
  }

  /**
   * Processes requests for Microsoft code review and analysis
   */
  async processRequest(
    request: string,
    context: any = {}
  ): Promise<{ response: string; data?: any; metadata?: any }> {
    try {
      const requestType = this.determineRequestType(request, context);

      switch (requestType) {
        case 'code-review':
          return await this.handleCodeReview(request, context);

        case 'security-analysis':
          return await this.handleSecurityAnalysis(request, context);

        case 'performance-analysis':
          return await this.handlePerformanceAnalysis(request, context);

        case 'architecture-review':
          return await this.handleArchitectureReview(request, context);

        case 'best-practices':
          return await this.handleBestPractices(request, context);

        case 'standards-validation':
          return await this.handleStandardsValidation(request, context);

        default:
          return await this.handleGeneralInquiry(request, context);
      }
    } catch (error) {
      console.error('Error in Microsoft Reviewer Agent:', error);
      return {
        response:
          'WystƒÖpi≈Ç b≈ÇƒÖd podczas analizy Microsoft. Spr√≥buj ponownie lub skontaktuj siƒô z administratorem.',
        metadata: { error: true, timestamp: new Date().toISOString() },
      };
    }
  }

  /**
   * Handles comprehensive code review requests
   */
  private async handleCodeReview(
    request: string,
    context: any
  ): Promise<{ response: string; data?: any; metadata?: any }> {
    const codeChanges = this.extractCodeChanges(context);
    const reviewType = this.extractReviewType(request, context);

    const reviewResult = await this.logic.performCodeReview(
      codeChanges,
      reviewType,
      context.options
    );

    return {
      response: this.formatCodeReviewResponse(reviewResult),
      data: reviewResult,
      metadata: {
        type: 'code-review',
        reviewType,
        changesCount: codeChanges.length,
        timestamp: new Date().toISOString(),
      },
    };
  }

  /**
   * Handles security analysis requests
   */
  private async handleSecurityAnalysis(
    request: string,
    context: any
  ): Promise<{ response: string; data?: any; metadata?: any }> {
    const codeChanges = this.extractCodeChanges(context);
    const securityContext = context.security || {};

    const securityAnalysis = await this.logic.analyzeSecurityVulnerabilities(
      codeChanges,
      securityContext
    );

    return {
      response: this.formatSecurityAnalysisResponse(securityAnalysis),
      data: securityAnalysis,
      metadata: {
        type: 'security-analysis',
        vulnerabilitiesFound: securityAnalysis.vulnerabilities.length,
        timestamp: new Date().toISOString(),
      },
    };
  }

  /**
   * Handles performance analysis requests
   */
  private async handlePerformanceAnalysis(
    request: string,
    context: any
  ): Promise<{ response: string; data?: any; metadata?: any }> {
    const codeChanges = this.extractCodeChanges(context);
    const performanceData = context.performance || {};

    const performanceAnalysis =
      await this.logic.analyzePerformanceOptimizations(
        codeChanges,
        performanceData
      );

    return {
      response: this.formatPerformanceAnalysisResponse(performanceAnalysis),
      data: performanceAnalysis,
      metadata: {
        type: 'performance-analysis',
        bottlenecksFound: performanceAnalysis.bottlenecks.length,
        timestamp: new Date().toISOString(),
      },
    };
  }

  /**
   * Handles architecture review requests
   */
  private async handleArchitectureReview(
    request: string,
    context: any
  ): Promise<{ response: string; data?: any; metadata?: any }> {
    const architectureContext = context.architecture || {};

    const microsoftAssessment = await this.logic.reviewArchitectureCompliance(
      architectureContext
    );

    return {
      response: this.formatArchitectureReviewResponse(microsoftAssessment),
      data: microsoftAssessment,
      metadata: {
        type: 'architecture-review',
        complianceScore: microsoftAssessment.bestPractices.overall,
        timestamp: new Date().toISOString(),
      },
    };
  }

  /**
   * Handles best practices requests
   */
  private async handleBestPractices(
    request: string,
    context: any
  ): Promise<{ response: string; data?: any; metadata?: any }> {
    const codeChanges = this.extractCodeChanges(context);
    const focusAreas = this.extractFocusAreas(request, context);

    const bestPractices = await this.logic.generateBestPracticeRecommendations(
      codeChanges,
      focusAreas
    );

    return {
      response: this.formatBestPracticesResponse(bestPractices),
      data: bestPractices,
      metadata: {
        type: 'best-practices',
        recommendationsCount: bestPractices.length,
        focusAreas,
        timestamp: new Date().toISOString(),
      },
    };
  }

  /**
   * Handles standards validation requests
   */
  private async handleStandardsValidation(
    request: string,
    context: any
  ): Promise<{ response: string; data?: any; metadata?: any }> {
    const codeChanges = this.extractCodeChanges(context);

    const validation = await this.logic.validateMicrosoftStandards(codeChanges);

    return {
      response: this.formatStandardsValidationResponse(validation),
      data: validation,
      metadata: {
        type: 'standards-validation',
        compliant: validation.compliant,
        violationsCount: validation.violations.length,
        timestamp: new Date().toISOString(),
      },
    };
  }

  /**
   * Handles general inquiries about Microsoft practices
   */
  private async handleGeneralInquiry(
    request: string,
    context: any
  ): Promise<{ response: string; data?: any; metadata?: any }> {
    void context; // Mark as used for ESLint

    return {
      response: `Jestem ekspertem Microsoft Reviewer. Mogƒô pom√≥c z:

‚Ä¢ üîç **Kompleksowym przeglƒÖdem kodu** - analiza zgodno≈õci z Microsoft standards
‚Ä¢ üõ°Ô∏è **AnalizƒÖ bezpiecze≈Ñstwa** - wykrywanie zagro≈ºe≈Ñ zgodnie z Microsoft SDL
‚Ä¢ ‚ö° **OptymalizacjƒÖ wydajno≈õci** - best practices .NET i Azure
‚Ä¢ üèóÔ∏è **PrzeglƒÖdem architektury** - Azure Well-Architected Framework
‚Ä¢ üìã **Rekomendacjami best practices** - standardy Microsoft i Azure

Jak mogƒô pom√≥c z Twoim projektem Microsoft/.NET/Azure?

**Przyk≈Çadowe ≈ºƒÖdania:**
- "Przeanalizuj bezpiecze≈Ñstwo tego kodu C#"
- "Oce≈Ñ wydajno≈õƒá aplikacji .NET"
- "Sprawd≈∫ zgodno≈õƒá z Azure best practices"
- "Przejrzyj architekturƒô mikroservis√≥w"`,
      metadata: {
        type: 'general-inquiry',
        capabilities: [
          'code-review',
          'security',
          'performance',
          'architecture',
          'best-practices',
        ],
        timestamp: new Date().toISOString(),
      },
    };
  }

  // Helper methods for request processing

  private determineRequestType(request: string, context: any): string {
    void context; // Mark as used for ESLint
    const lower = request.toLowerCase();

    const patterns = {
      'security-analysis': ['bezpiecze≈Ñst', 'security', 'vulnerab'],
      'performance-analysis': ['wydajno≈õ', 'performance', 'optym'],
      'architecture-review': ['architekt', 'design', 'well-architect'],
      'best-practices': ['best practic', 'standard', 'guideline'],
      'standards-validation': ['walidacj', 'validat', 'compliance'],
      'code-review': ['przeglƒÖd', 'review', 'analiz'],
    };

    for (const [type, keywords] of Object.entries(patterns)) {
      if (keywords.some(keyword => lower.includes(keyword))) {
        return type;
      }
    }

    return 'general-inquiry';
  }

  private extractCodeChanges(context: any): CodeChange[] {
    if (!context || !context.codeChanges) {
      return [];
    }

    return Array.isArray(context.codeChanges) ? context.codeChanges : [];
  }

  private extractReviewType(request: string, context: any): string {
    void request; // Mark as used for ESLint

    if (context && context.reviewType) {
      return context.reviewType;
    }

    return 'full_review';
  }

  private extractFocusAreas(request: string, context: any): string[] {
    void request; // Mark as used for ESLint

    if (context && context.focusAreas && Array.isArray(context.focusAreas)) {
      return context.focusAreas;
    }

    return [];
  }

  // Response formatting methods

  private formatCodeReviewResponse(result: CodeReviewResult): string {
    const overall = result.overall;

    return `# üìã Microsoft Code Review - Raport

## üéØ Og√≥lna Ocena
**Rating:** ${this.translateRating(overall.rating)} (${overall.score}/100)

${overall.summary}

### üîç Kluczowe Ustalenia:
${overall.keyFindings.map(finding => `‚Ä¢ ${finding}`).join('\n')}

## üìä Szczeg√≥≈Çowa Analiza

### üèóÔ∏è Jako≈õƒá Kodu
- **Maintainability:** ${result.quality.maintainability.rating} (${
      result.quality.maintainability.score
    }/100)
- **Reliability:** ${result.quality.reliability.rating} (${
      result.quality.reliability.score
    }/100)
- **Testability:** ${result.quality.testability.rating} (${
      result.quality.testability.score
    }/100)

### üõ°Ô∏è Bezpiecze≈Ñstwo
- **Overall Security:** ${result.security.overall.rating} (${
      result.security.overall.score
    }/100)
- **Risk Level:** ${this.translateRisk(result.security.overall.riskLevel)}
- **Vulnerabilities:** ${result.security.vulnerabilities.critical} critical, ${
      result.security.vulnerabilities.high
    } high

### ‚ö° Wydajno≈õƒá
- **Performance Score:** ${result.performance.overall.score}/100
- **Rating:** ${this.translateRating(result.performance.overall.rating)}
- **Bottlenecks Identified:** ${result.performance.bottlenecks.identified}

### üè¢ Microsoft Compliance
- **Best Practices:** ${result.microsoft.bestPractices.overall}% compliance
- **Azure Optimization:** Dostƒôpne rekomendacje
- **.NET Standards:** Zgodno≈õƒá potwierdzona

## üéØ Rekomendacje (${result.recommendations.total})
- **Krytyczne:** ${result.recommendations.byPriority.critical}
- **Wysokie:** ${result.recommendations.byPriority.high}
- **≈örednie:** ${result.recommendations.byPriority.medium}
- **Niskie:** ${result.recommendations.byPriority.low}

**Szacowany czas implementacji:** ${
      result.recommendations.effort.total
    } godzin`;
  }

  private formatSecurityAnalysisResponse(analysis: SecurityAnalysis): string {
    const vulnCount = analysis.vulnerabilities.length;

    return `# üõ°Ô∏è Microsoft Security Analysis

## üîç Podsumowanie Bezpiecze≈Ñstwa
**Znalezione vulnerabilities:** ${vulnCount}

### üö® Stan Bezpiecze≈Ñstwa:
- **Data Protection:** ${analysis.dataProtection.length} kontroli
- **Authentication:** ${analysis.authentication.length} weryfikacji
- **Authorization:** ${analysis.authorization.length} sprawdze≈Ñ
- **Input Validation:** ${analysis.inputValidation.length} walidacji
- **Cryptography:** ${analysis.cryptography.length} analiz

## üìã Microsoft SDL Compliance
Analiza zgodno≈õci z Microsoft Security Development Lifecycle zosta≈Ça przeprowadzona zgodnie z najnowszymi wytycznymi.

### üéØ Rekomendacje Bezpiecze≈Ñstwa:
${
  vulnCount > 0
    ? '‚Ä¢ Wykryto potencjalne zagro≈ºenia wymagajƒÖce natychmiastowej uwagi\n‚Ä¢ Szczeg√≥≈Çowa analiza dostƒôpna w raporcie'
    : '‚Ä¢ Nie wykryto krytycznych zagro≈ºe≈Ñ bezpiecze≈Ñstwa\n‚Ä¢ Kod spe≈Çnia podstawowe standardy Microsoft SDL'
}

**Nastƒôpne kroki:** Implementacja zalecanych poprawek zgodnie z priorytetem.`;
  }

  private formatPerformanceAnalysisResponse(
    analysis: PerformanceAnalysis
  ): string {
    const bottlenecks = analysis.bottlenecks.length;
    const optimizations = analysis.optimizations.length;

    return `# ‚ö° Microsoft Performance Analysis

## üéØ Analiza Wydajno≈õci
**Wykryte bottlenecks:** ${bottlenecks}
**Mo≈ºliwo≈õci optymalizacji:** ${optimizations}

### üìä Wykorzystanie Zasob√≥w:
- **Memory Usage:** Analiza wzorc√≥w alokacji pamiƒôci
- **CPU Performance:** Identyfikacja hotspots wydajno≈õci
- **I/O Operations:** Optymalizacja operacji dyskowych i sieciowych

### üöÄ Scalability Assessment:
Ocena gotowo≈õci do skalowania poziomego i pionowego zgodnie z Azure best practices.

## üéØ .NET Performance Guidelines
Analiza zgodno≈õci z Microsoft performance guidelines dla:
- Garbage Collection optimization
- Async/await patterns
- Memory management
- Resource pooling

### üìà Rekomendacje Optymalizacji:
${
  bottlenecks > 0
    ? `‚Ä¢ Zidentyfikowano ${bottlenecks} obszar√≥w wymagajƒÖcych optymalizacji\n‚Ä¢ Potencjalna poprawa wydajno≈õci: znaczƒÖca`
    : '‚Ä¢ Kod spe≈Çnia standardy wydajno≈õci Microsoft\n‚Ä¢ Dostƒôpne dodatkowe optymalizacje dla advanced scenarios'
}`;
  }

  private formatArchitectureReviewResponse(
    assessment: MicrosoftAssessment
  ): string {
    const compliance = assessment.bestPractices.overall;

    return `# üèóÔ∏è Microsoft Architecture Review

## üéØ Azure Well-Architected Assessment
**Overall Compliance:** ${compliance}%

### üè¢ Microsoft Architecture Patterns:
- **Clean Architecture:** Ocena implementacji
- **Microservices Patterns:** Analiza zgodno≈õci
- **Cloud-Native Design:** Azure readiness assessment
- **Event-Driven Architecture:** Pattern usage review

### ‚òÅÔ∏è Azure Optimization:
${
  assessment.azure.services.length > 0
    ? `‚Ä¢ Przeanalizowano ${assessment.azure.services.length} serwis√≥w Azure\n‚Ä¢ Zidentyfikowano mo≈ºliwo≈õci optymalizacji koszt√≥w i wydajno≈õci`
    : '‚Ä¢ Gotowo≈õƒá do wdro≈ºenia w Azure\n‚Ä¢ Rekomendowane serwisy i konfiguracje dostƒôpne'
}

### üéØ .NET Standards Compliance:
- **Coding Standards:** Zgodno≈õƒá z Microsoft guidelines
- **Design Patterns:** SOLID principles implementation
- **Package Management:** Dependency security i updates

## üìã Rekomendacje Architektoniczne:
**Priorytety implementacji:**
1. Infrastructure optimization
2. Security hardening  
3. Performance tuning
4. Cost optimization

**Timeline:** Fazowa implementacja zgodnie z Microsoft best practices`;
  }

  private formatBestPracticesResponse(practices: any[]): string {
    return `# üìã Microsoft Best Practices

## üéØ Rekomendacje Microsoft Standards

### üè¢ Zidentyfikowane Obszary:
${practices
  .map(
    practice => `
**${practice.category.toUpperCase()}**
- **Rule:** ${practice.rule}
- **Status:** ${this.translateCompliance(practice.compliance)}
- **Recommendation:** ${practice.recommendation}
`
  )
  .join('\n')}

## üìö Dokumentacja Reference:
Wszystkie rekomendacje oparte na oficjalnej dokumentacji Microsoft i Azure best practices.

### üéØ Nastƒôpne Kroki:
1. **Immediate Actions:** Krytyczne poprawki
2. **Short-term:** Implementacja core recommendations  
3. **Long-term:** Advanced optimizations

**Priorytet:** Implementacja zgodnie z business impact i effort required.`;
  }

  private formatStandardsValidationResponse(validation: any): string {
    const status = validation.compliant ? '‚úÖ COMPLIANT' : '‚ùå NON-COMPLIANT';
    const violationsCount = validation.violations.length;

    return `# ‚úÖ Microsoft Standards Validation

## üéØ Compliance Status: ${status}

### üìä Validation Summary:
- **Violations Found:** ${violationsCount}
- **Recommendations:** ${validation.recommendations.length}

${
  violationsCount > 0
    ? `
### ‚ö†Ô∏è Areas Requiring Attention:
${validation.violations
  .map((v: any) => `‚Ä¢ ${v.area}: ${v.description}`)
  .join('\n')}
`
    : '### ‚ú® Excellent Compliance!\nKod spe≈Çnia wszystkie sprawdzone standardy Microsoft.'
}

### üìã Microsoft Guidelines Checked:
- **Coding Standards:** .NET Design Guidelines compliance
- **Security Standards:** Microsoft SDL requirements
- **Performance Standards:** .NET performance best practices  
- **Architecture Standards:** Azure Well-Architected principles

## üéØ Action Plan:
${validation.recommendations.map((rec: string) => `‚Ä¢ ${rec}`).join('\n')}

**Compliance Level:** ${
      validation.compliant ? 'Enterprise Ready' : 'Requires Improvements'
    }`;
  }

  // Translation helper methods

  private translateRating(rating: string): string {
    const translations = {
      excellent: 'Doskona≈Çy',
      good: 'Dobry',
      acceptable: 'Akceptowalny',
      poor: 'S≈Çaby',
      critical: 'Krytyczny',
    };
    return translations[rating as keyof typeof translations] || rating;
  }

  private translateRisk(risk: string): string {
    const translations = {
      low: 'Niskie',
      medium: '≈örednie',
      high: 'Wysokie',
      critical: 'Krytyczne',
    };
    return translations[risk as keyof typeof translations] || risk;
  }

  private translateCompliance(compliance: string): string {
    const translations = {
      compliant: 'Zgodny',
      partial: 'Czƒô≈õciowo zgodny',
      non_compliant: 'Niezgodny',
    };
    return translations[compliance as keyof typeof translations] || compliance;
  }
}
